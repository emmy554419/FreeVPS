name: Keep Running VS Code Ubuntu

on:
  workflow_dispatch:

jobs:
  vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # max 6 hours

    steps:
    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y wget curl unzip jq

    - name: Install code-server
      run: |
        curl -fsSL https://code-server.dev/install.sh | sh

    - name: Start code-server
      run: |
        # Run code-server in background, no auth
        nohup code-server --bind-addr 127.0.0.1:8080 --auth none > code-server.log 2>&1 &

    - name: Install ngrok
      run: |
        curl -s https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
        unzip ngrok.zip
        chmod +x ngrok

    - name: Authenticate ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        ./ngrok authtoken $NGROK_AUTH_TOKEN

    - name: Start ngrok tunnel
      run: |
        nohup ./ngrok http 8080 --log=stdout > ngrok.log 2>&1 &
        sleep 5
        # Print public URL
        ./ngrok api tunnels | jq -r '.tunnels[0].public_url'

    - name: Keep Runner Alive
      run: |
        echo "Runner is now alive. Access VS Code at the printed ngrok URL."
        sleep infinity