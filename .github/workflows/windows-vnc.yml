name: Keep Running VS Code Ubuntu

on:
  workflow_dispatch:

jobs:
  vscode:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # max 6 hours

    steps:
    - name: Install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y wget curl unzip jq

    - name: Install code-server
      run: |
        curl -fsSL https://code-server.dev/install.sh | sh

    - name: Start code-server
      run: |
        # Run code-server in background, no authentication
        nohup code-server --bind-addr 127.0.0.1:8080 --auth none > code-server.log 2>&1 &

    - name: Install ngrok
      run: |
        curl -s https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
        unzip ngrok.zip
        chmod +x ngrok

    - name: Authenticate ngrok
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        ./ngrok authtoken $NGROK_AUTH_TOKEN

    - name: Start ngrok tunnel and print URL continuously
      run: |
        # Start ngrok in background
        nohup ./ngrok http 8080 --log=stdout > ngrok.log 2>&1 &

        echo "Waiting for ngrok to start..."
        URL=""
        # Retry until ngrok URL is available
        for i in {1..15}; do
          sleep 2
          URL=$(curl --silent http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url' 2>/dev/null)
          if [ ! -z "$URL" ] && [ "$URL" != "null" ]; then
            echo "Ngrok URL: $URL"
            break
          fi
        done

        if [ -z "$URL" ] || [ "$URL" == "null" ]; then
          echo "Error: Ngrok URL not found!"
        fi

        # Keep printing URL continuously and keep runner alive
        echo "Runner is now alive. Access VS Code at the printed ngrok URL."
        while true; do
          if [ ! -z "$URL" ]; then
            echo "Ngrok URL: $URL"
          fi
          sleep 10
        done