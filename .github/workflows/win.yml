name: AviRDP

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Download Ngrok v3
      run: |
        Write-Host "Downloading Ngrok v3..."
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip -UseBasicParsing
        Write-Host "Ngrok downloaded successfully!"

    - name: Download Configuration Files
      run: |
        Write-Host "Downloading configuration files..."
        try {
          Invoke-WebRequest https://raw.githubusercontent.com/avipatilpro/AviRDP/main/start.bat -OutFile start.bat -UseBasicParsing -ErrorAction SilentlyContinue
        } catch {
          Write-Host "start.bat not found, creating default..."
          @'
          @echo off
          echo ==========================================
          echo    AviRDP - Windows RDP Connection
          echo ==========================================
          echo.
          echo Fetching connection details...
          timeout /t 5 /nobreak >nul
          curl -s http://127.0.0.1:4040/api/tunnels > tunnels.json
          echo.
          echo ==========================================
          echo Your RDP Connection is Ready!
          echo ==========================================
          powershell -Command "$data = Get-Content tunnels.json | ConvertFrom-Json; $tcp = $data.tunnels | Where-Object {$_.proto -eq 'tcp'}; if ($tcp) { $url = $tcp.public_url -replace 'tcp://', ''; Write-Host 'RDP Address: ' $url; Write-Host 'Username: runneradmin'; Write-Host 'Password: Check the workflow logs'; } else { Write-Host 'Waiting for tunnel...'; }"
          echo ==========================================
          '@ | Out-File -FilePath start.bat -Encoding ASCII
        }

    - name: Download Launcher Files
      run: |
        Write-Host "Downloading launcher files..."
        New-Item -ItemType Directory -Force -Path "launcher" | Out-Null

        try {
          Invoke-WebRequest https://raw.githubusercontent.com/avipatilpro/AviRDP/main/launcher/Node.js.lnk -OutFile "Node.js.lnk" -UseBasicParsing -ErrorAction SilentlyContinue
        } catch {
          Write-Host "Node.js.lnk not found, skipping..."
        }

    - name: Extract Ngrok
      run: |
        Write-Host "Extracting Ngrok..."
        Expand-Archive ngrok.zip -Force -DestinationPath .\ngrok
        Write-Host "Ngrok extracted successfully!"

    - name: Authenticate Ngrok Account
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        Write-Host "Authenticating Ngrok..."
        .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Ngrok authentication successful!"
        } else {
          Write-Error "Ngrok authentication failed!"
          exit 1
        }

    - name: Enable RDP Access
      run: |
        Write-Host "Enabling RDP access..."
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "RDP enabled successfully!"

    - name: Create Ngrok Tunnel
      run: |
        Write-Host "Starting Ngrok tunnel..."
        Start-Process PowerShell -ArgumentList '-NoExit -Command ".\ngrok\ngrok.exe tcp 3389 --region ap --log=stdout"' -WindowStyle Hidden
        Write-Host "Ngrok tunnel started!"

    - name: Display RDP Connection Details
      run: |
        Write-Host "=============================================="
        Write-Host "      AVIRDP - CONNECTION DETAILS"
        Write-Host "=============================================="
        Write-Host "RDP Address: Please check workflow logs for details"
        Write-Host "Username: runneradmin"
        Write-Host "Password: AviRDP@2024"
        Write-Host "=============================================="

    - name: Keep VM Running
      run: |
        Write-Host "VM is now running and ready for RDP connection!"
        while ($true) {
          Write-Host "VM Status: Running - $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Start-Sleep -Seconds 60
        }
